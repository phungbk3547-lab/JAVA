<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<header class="navbar">
    <button class="menu-btn" id="menuToggle">☰</button>
    <div class="site-title">⚡ EV Trading</div>
    <div style="position: relative;">
        <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="user-avatar" id="userAvatar">
        <div class="dropdown" id="userDropdown">
            <a href="/" class="dropdown-item">Trang chủ</a>
            <a href="/logout" class="dropdown-item">Đăng xuất</a>
        </div>
    </div>
</header>

<nav class="side-menu" id="sideMenu">
    <a href="/" class="menu-item">Trang chủ</a>
    <a href="/admin/dashboard" class="menu-item active">Tổng quan</a>
    <a href="/admin/complaint" class="menu-item">Khiếu nại
        <span th:if="${complaintCount > 0}" class="badge-count" th:text="${complaintCount}"></span>
    </a>
    <a href="/logout" class="menu-item" style="border-top: 1px solid #bbb; margin-top: 10px;">Đăng xuất</a>
</nav>

<div class="dashboard-container">

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon icon-blue"><i class="fas fa-users"></i></div>
            <div class="stat-info"><h3 th:text="${totalUsers}">0</h3><p>Thành viên</p></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon icon-green"><i class="fas fa-check-circle"></i></div>
            <div class="stat-info"><h3 th:text="${activeCount}">0</h3><p>Tin đang bán</p></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon icon-yellow"><i class="fas fa-clock"></i></div>
            <div class="stat-info"><h3 th:text="${pendingCount}">0</h3><p>Chờ duyệt</p></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon icon-red"><i class="fas fa-exclamation-triangle"></i></div>
            <div class="stat-info"><h3 th:text="${complaintCount}">0</h3><p>Khiếu nại</p></div>
        </div>
    </div>

    <div class="charts-row">

        <div class="chart-card" style="flex: 1.2;">
            <div class="chart-title">Thống kê tin đăng</div>
            <div class="chart-wrapper">
                <canvas id="postChart"></canvas>
            </div>
        </div>

        <div class="chart-card user-data-card" style="flex: 1;">
            <div class="user-card-header">
                <div class="card-title-box">
                    <i class="fas fa-address-book"></i> User Data
                </div>
                <div class="card-filter">
                    <select class="mini-select"><option>All Time</option></select>
                </div>
            </div>

            <div class="user-list-container">
                <table class="user-table">
                    <thead>
                    <tr>
                        <th style="width: 30px;"><input type="checkbox"></th>
                        <th>NAME</th>
                        <th>ROLE</th>
                        <th>TYPE</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="u : ${recentUsers}">
                        <td><input type="checkbox"></td>
                        <td>
                            <div class="user-info">
                                <div class="u-name" th:text="${u.name}">User Name</div>
                                <div class="u-email" th:text="${u.email}">email@example.com</div>
                            </div>
                        </td>
                        <td>
                            <span th:if="${u.role == 'ADMIN'}" class="role-badge role-admin">Admin</span>
                            <span th:if="${u.role == 'USER'}" class="role-badge role-user">User</span>
                        </td>
                        <td>
                            <select class="type-select" th:if="${u.role == 'ADMIN'}">
                                <option>Full Control</option>
                            </select>
                            <select class="type-select" th:if="${u.role == 'USER'}">
                                <option>Post Only</option>
                                <option>View Only</option>
                            </select>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="user-card-footer">
                <button class="btn-load-more">LOAD MORE</button>
            </div>
        </div>
    </div>

    <h3 style="color: #696969; margin-bottom: 15px; margin-top: 30px; font-weight: 700;">
        <i class="fas fa-tasks"></i> Kiểm duyệt tin đăng
    </h3>

    <div class="table-responsive">
        <table class="admin-table">
            <thead>
            <tr>
                <th>Ngày đăng</th>
                <th>Tiêu đề</th>
                <th>Loại</th>
                <th>Giá (VNĐ)</th>
                <th>Trạng thái</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="post : ${allPosts}">
                <td th:text="${#temporals.format(post.createdAt, 'dd/MM/yyyy HH:mm')}">...</td>

                <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                    th:text="${post.title}" title="${post.title}">...</td>

                <td>
                    <span th:if="${post.category == 'EV'}" style="color:#00b26f; font-weight:bold">Xe điện</span>
                    <span th:if="${post.category == 'PIN'}" style="color:#f0ad4e; font-weight:bold">Pin</span>
                </td>

                <td th:text="${#numbers.formatDecimal(post.price, 0, 'COMMA', 0, 'POINT')}">...</td>

                <td>
                    <div th:if="${post.status == 'PENDING'}">
                        <form th:action="@{/admin/post/approve/{id}(id=${post.id})}" method="post" style="display:inline;">
                            <button class="action-btn btn-check" title="Duyệt đăng bài">
                                <i class="fas fa-check"></i>
                            </button>
                        </form>
                        <form th:action="@{/admin/post/reject/{id}(id=${post.id})}" method="post" style="display:inline;"
                              onsubmit="return confirm('Xác nhận đánh dấu bài này là VI PHẠM?');">
                            <button class="action-btn btn-x" title="Báo vi phạm">
                                <i class="fas fa-times"></i>
                            </button>
                        </form>
                    </div>

                    <div th:if="${post.status == 'APPROVED'}">
                                <span class="status-badge status-approved">
                                    <i class="fas fa-check-circle"></i> Đã đăng
                                </span>
                    </div>

                    <div th:if="${post.status == 'REJECTED'}">
                                <span class="status-badge status-rejected">
                                    <i class="fas fa-ban"></i> Vi phạm
                                </span>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <footer class="footer">
        © 2025 EV Trading Platform ⚡ — Nền tảng giao dịch xe điện &amp; pin đã qua sử dụng
    </footer>
</div>

<script src="/js/script.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {

        // --- 1. BIỂU ĐỒ CỘT: THỐNG KÊ TIN ĐĂNG ---
        const ctxPost = document.getElementById('postChart');

        if (ctxPost) {
            const gradient = ctxPost.getContext('2d').createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, '#00b26f');  // Màu xanh chủ đạo (Đậm ở trên)
            gradient.addColorStop(1, 'rgba(0, 178, 111, 0.1)'); // Nhạt dần xuống dưới (Trong suốt)

            new Chart(ctxPost, {
                type: 'bar',
                data: {
                    labels: ['Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11'],
                    datasets: [{
                        label: 'Tin đăng mới',
                        data: [3, 4, 1, 2],
                        backgroundColor: gradient, // Dùng màu Xanh mới
                        borderColor: '#00b26f',    // Viền cũng màu xanh
                        borderWidth: 1,
                        borderRadius: 6,           // Bo tròn góc cột nhiều hơn xíu cho mềm mại
                        barThickness: 35,          // Cột vừa vặn
                        maxBarThickness: 50
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }, // Ẩn chú thích
                        tooltip: {
                            backgroundColor: '#303030', // Tooltip màu đen cho dễ đọc
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            padding: 10,
                            displayColors: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { borderDash: [4, 4], color: '#f0f0f0' }, // Lưới nét đứt mờ
                            ticks: { color: '#888', font: {family: "'Poppins', sans-serif"} }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#555', font: {family: "'Poppins', sans-serif", weight: '500'} }
                        }
                    }
                }
            });
        }
    });
</script>

</body>
</html>